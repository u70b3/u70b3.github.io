---
title: 两个线程交替输出0-100
date: 2021-07-23 10:32:12
description: 实现一个带状态的自旋锁解决这个问题会非常方便
tags: 
    - C++
    - 代码实现
---

## 背景

两个线程交替输出0-100是一个经典的并发同步问题，使用互斥锁比较麻烦，原因是过程中有4个状态，硬写不太优雅，这里实现一个带状态的自旋锁解决。

## 代码实现

```c++
#include <iostream>
#include <thread>
#include <atomic>

#include "unistd.h"

using namespace std;

// 0: t1_writeable, 1: t1_writing, 2: t2_writeable, 3: t2_writing
atomic<int> state;

// ps: compare_exchange_weak/strong both ok in x86, strong use in ARM or xx

void f1()
{
    for (int i = 0; i <= 100; i += 2)
    {
        // spinlock with state
        while (true)
        {
            int expected = 0;
            if (state.compare_exchange_weak(expected, 1))
                break;
            // for performance
            usleep(1);
        }
        cout << i << " ";
        state = 2;
    }
}

void f2()
{
    for (int i = 1; i <= 100; i += 2)
    {
        // spinlock with state
        while (true)
        {
            int expected = 2;
            if (state.compare_exchange_weak(expected, 3))
                break;
            // for performance
            usleep(1);
        }
        cout << char(i + 'a') << " ";
        state = 0;
    }
}

int main()
{
    state = 0;
    thread t1(f1), t2(f2);
    t1.join();
    t2.join();
    return 0;
}
// g++ problem_two_thread.cpp -std=c++17 -o test && ./test && rm ./test
```
